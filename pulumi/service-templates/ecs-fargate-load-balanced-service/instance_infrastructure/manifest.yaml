infrastructure:
  templates:
    - rendering_engine: codebuild
      settings:
        image: aws/codebuild/amazonlinux2-x86_64-standard:4.0
        runtimes:
          nodejs: 16
        env:
          variables:
            PULUMI_ORG: <PULUMI-ORG-HERE>
            PULUMI_NAMESPACE: proton-service
          secrets_manager:
            PULUMI_ACCESS_TOKEN: "proton/pulumi-access-token:Secret"
        provision:
          - cat proton-inputs.json
          - curl -fsSL https://get.pulumi.com | sh
          - export PATH=$PATH:$HOME/.pulumi/bin
          - npm install
          - pulumi stack select $PULUMI_ORG/$PULUMI_NAMESPACE/$STACK_NAME || pulumi stack init $PULUMI_ORG/$PULUMI_NAMESPACE/$STACK_NAME
          - pulumi config set aws:region $AWS_DEFAULT_REGION
          - pulumi config set org $PULUMI_ORG
          - pulumi up --yes --stack $PULUMI_ORG/$PULUMI_NAMESPACE/$STACK_NAME
          - chmod +x ./pulumi-to-proton-outputs.sh
          - pulumi stack output --json | ./pulumi-to-proton-outputs.sh > outputs.json
          - aws proton notify-resource-deployment-status-change --resource-arn $RESOURCE_ARN --status IN_PROGRESS --outputs file://./outputs.json --endpoint https://us-east-1.gamma.frontend.arrow.aws.dev/
        deprovision:
          - curl -fsSL https://get.pulumi.com | sh
          - export PATH=$PATH:$HOME/.pulumi/bin
          - npm install
          - pulumi stack select $PULUMI_ORG/$PULUMI_NAMESPACE/$STACK_NAME
          - pulumi config set aws:region $AWS_DEFAULT_REGION
          - pulumi config set org $PULUMI_ORG
          - pulumi destroy --yes -s $PULUMI_ORG/$STACK_NAME
